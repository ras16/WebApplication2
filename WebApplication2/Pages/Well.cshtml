@page
@model WebApplication2.Pages.WellModel
@{
}
<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="~/css/style.css" />
    <link rel="stylesheet" href="~/css/well.css" />
    <link rel="stylesheet" href="~/css/layout.css" />
    <title>Gas Wells</title>

</head>
<body>

    <div class="container">

        <div class="option">

            <label for="wellID"> Select a Well: </label>

            <select name="wellID" id="wellID" onchange="fetchWellData()">
                <option value=""></option>
                @foreach (var item in Model.WellsList)
                {
                    <option value="@item.WellID">@item.WellID - @item.WellName</option>
                }
            </select>

        </div>

        <hr />
        <button class="button" onclick="location.href='/WellTestForm'">

            <span class="button__text">Add</span>
            <span class="button__icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" viewBox="0 0 24 24" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" stroke="currentColor" height="24" fill="none" class="svg">
                    <line y2="19" y1="5" x2="12" x1="12"></line>
                    <line y2="12" y1="12" x2="19" x1="5"></line>
                </svg>
            </span>
        </button>

        <div id="wellDetails">
            <p>Select a well to view details.</p>
        </div>

        <script>

            function fetchWellData() {
                const wellID = document.getElementById("wellID").value;
                if (!wellID) {
                    document.getElementById("wellDetails").innerHTML = "<p>Select a well to view details.</p>";
                    return;
                }

                fetch(`?handler=GetWellData&wellID=${wellID}`)
                    .then(response => response.json())
                    .then(data => {
                        displayWellData(data);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        document.getElementById("wellDetails").innerHTML = "<p>Error fetching well data. Please try again.</p>";
                    });
            }
            function displayWellData(data) {
                if (data && data.length > 0) {
                    let tableHTML = `
                        <br>
                        <h3>Summary Data for Well ID: ${data[0].well_id}</h3>
                        <p class="header">Found ${data.length} record(s):</p>
                        <table border="1">
                            <thead>
                                <tr>
                                    <th class="sticky-id-header">ID</th>
                                    <th>Date</th>
                                    <th>Well ID</th>
                                    <th>Production Interval</th>
                                    <th>Test Type</th>
                                    <th>Flow Type</th>
                                    <th>Hours Tested</th>
                                    <th>Avg TBG Choke</th>
                                    <th>Avg CSG Choke</th>
                                    <th>Avg THP Barg</th>
                                    <th>Avg THT F</th>
                                    <th>Avg CHP Barg</th>
                                    <th>Avg Oil M3/Day</th>
                                    <th>Avg Water M3/Day</th>
                                    <th>Avg Gas 10^6 M3/Day</th>
                                    <th>GOR</th>
                                    <th>Avg Inj Gas Rate</th>
                                    <th>Oil SG</th>
                                    <th>Gas SG</th>
                                    <th>Oil Mt/Day</th>
                                    <th>NaCl PPM</th>
                                    <th>BSW</th>
                                    <th>Test Company</th>
                                    <th>Rig Kit</th>
                                    <th>Entered By</th>
                                    <th>No Prod</th>
                                    <th>Comments</th>
                                    <th>Interval Top</th>
                                    <th>Interval Bottom</th>
                                    <th>Representative Ind</th>
                                </tr>
                            </thead>
                            <tbody>`;

                    // Loop through all records and add a row for each one
                    data.forEach(record => {
                        tableHTML += `
                            <tr>
                                    <td class="sticky-id">${record.id}</td>
                                    <td>${record.well_id}</td>
                                    <td>${record.test_date}</td>
                                    <td>${record.prod_int}</td>
                                    <td>${record.test_type}</td>
                                    <td>${record.flow_type}</td>
                                    <td>${record.hours_tested}</td>
                                    <td>${record.avg_tbg_choke_64}</td>
                                    <td>${record.avg_csg_choke_64}</td>
                                    <td>${record.avg_thp_barg}</td>
                                    <td>${record.avg_tht_f}</td>
                                    <td>${record.avg_chp_barg}</td>
                                    <td>${record.avg_oil_m3_per_day}</td>
                                    <td>${record.avg_water_m3_per_day}</td>
                                    <td>${record.avg_gas_10_6_m3_per_day}</td>
                                    <td>${record.gor}</td>
                                    <td>${record.avg_inj_gas_rate}</td>
                                    <td>${record.oil_sg}</td>
                                    <td>${record.gas_sg}</td>
                                    <td>${record.oil_mt_per_day}</td>
                                    <td>${record.nacl_ppm}</td>
                                    <td>${record.bsw}</td>
                                    <td>${record.test_company}</td>
                                    <td>${record.rig_kit}</td>
                                    <td>${record.entered_by}</td>
                                    <td>${record.no_prod}</td>
                                    <td>${record.comments}</td>
                                    <td>${record.interval_top}</td>
                                    <td>${record.interval_bottom}</td>
                                    <td>${record.representative_ind}</td>
                            </tr>`;
                    });

                    tableHTML += `
                            </tbody>
                        </table>`;

                    document.getElementById("wellDetails").innerHTML = tableHTML;
                } else {
                    document.getElementById("wellDetails").innerHTML = "<p class='header'>No data found for this Well ID.</p>";
                }
            }

        </script>

        @* Add this to enable AJAX calls *@
        @section Scripts {
            <script>
                // Add anti-forgery token to all fetch requests
                function addAntiForgeryToken(url) {
                    return url + (url.indexOf('?') === -1 ? '?' : '&') + '_=' + new Date().getTime();
                }

                // Override fetch to include the anti-forgery token
                const originalFetch = window.fetch;
                window.fetch = function(url, options) {
                    if (typeof url === 'string' && url.includes('?handler=')) {
                        url = addAntiForgeryToken(url);
                        options = options || {};
                        options.headers = options.headers || {};
                        options.headers['X-Requested-With'] = 'XMLHttpRequest';
                    }
                    return originalFetch.call(this, url, options);
                };
            </script>
        }
    </div>

</body>
</html>